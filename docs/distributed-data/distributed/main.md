## 分布式系统的复杂性
分布式系统不同于单机系统，其复杂性要高的多，会出现各种各种奇奇怪怪的问题。比如：网络故障，时钟不同步，时钟跳跃，进程执行过程中长时间暂停等问题。
作为开发者，我们的目标是即使底层硬件不可靠，我们也要构建出容错的，可靠的系统。

#### 为什么选择分布式系统
可扩展，容错，低延迟

#### 部分失效
在分布式系统中，可能会出现系统的一部分工作正常，但其它部分出现难以预测的故障，我们称之为“部分故障”。问题的难点在于这种部分失效是不确定的，如果涉及
多个网络和节点，几乎肯定会遇到有时候网络正常，有时候莫名的失败。正是因为这种不确定性和部分失效大大提高了分布式系统的复杂性。

也就是说部分失效是分布式系统的关键特征。只要软件试图跨节点做任何事情，就可能出现失败或随即变慢，或者根本无法应答。对于分布式系统，我们的目标是建立容忍
部分失效的软件系统，这样即使某些部件发生失效，系统整体还可以正常运行。

#### 故障检测
为了容忍部分失效，容忍分布式系统出现错误，第一步是检测错误，但是这并不容易。多数系统没有检测检点是否发生故障的准确机制，因此分布式算法更多是依靠
超时来确定远程节点是否可用。但是超时时间的设置并不是一件容易的事情：
* 超时时间过短：当网络波动或节点负载过大时，无法及时处理请求。当超时时间过短，会引起不必要的集群动态再平衡（如路由再平衡，分区再平衡，重新选主等）
* 超时时间过长：无法及时检测到节点的状态

另外，超时无法区分网络和节点故障，且可变的网络故障延迟有时候会导致节点被误认为发生故障。

#### 不可靠的分布式系统
分布式系统有很多的不可靠：通过不可靠网络传递消息且延迟不确定，部分节点可能失效，时钟不可靠，节点有可能发生进程暂停。

#### 拜占庭故障
之前讨论的分片，复制等假设节点虽然不可靠，但是一定是诚实的：它们尽管运行很慢或者由于故障无法响应，但是一旦做出了响应，那么响应肯定是*真实的*。
如果节点存在“撒谎”的情况，那么分布式系统的处理难度会更上一个台阶。例如节点没有收到某条消息但却对外部声称收到了。这种行为称为`拜占庭故障`，在这样
的不信任环境中需要达成共识的问题也被称为`拜占庭将军问题`。

不过在大多数互联网应用中，不存在拜占庭故障。因为互联玩应用的节点都是由一个可信任的组织来集中控制的。不过对于区块链来说，因为是去中心化的，所以会存在
拜占庭故障。

## 不可靠的网络
互联网以及大多数数据中心的内部网络都是异步网络。在这种网络中，一个节点可以发送消息（数据包）到另一个节点，但是网络并不能保证它什么适合到达。发送之后
等待响应过程中，有很多错误可能发生：
1. 请求可能已经丢失（有人拔掉了网线）
2. 请求可能正在某个队列里面等待，无法立即发送
3. 远程节点可能失效（关机或崩溃）
4. 远程节点可能暂时无法响应（长时间`GC`，进程中断）
5. 远程接收节点已经完成了请求处理，但是回复却在网络中丢失（例如网络交换机配置错误）
6. 远程接收节点已经完成了请求处理，但是回复却被延迟处理（例如网络或发送者的机器超出负荷）

## 不可靠的时钟
时钟和计时非常重要，有许多应用程序以各种方式依赖应用程序：
1. 某个请求是否超时了
2. 某个接口99%的响应时间是多少
3. 用户浏览主页花费了多长时间
4. 什么适合发送邮件提醒
5. 缓存什么适合过期

其中1-3测量的是持续时间，而4，5测量的是某个时间点。

每台机器都有自己的时钟硬件设备，通常是石英振荡器。这些设备并非绝对准确，即每台机器都维护着自己本地的时间版本。可以在一定会程度上同步机器之间的时钟，
最常用的方法是网络时间协议（NTP），它可以根据一组专门的时间服务器来调整本地时间，时间服务器则从精确度更高的时间源（如GPS接收机）获取高精度时间。

#### 单调时钟与墙上时钟
现代计算机内部有两种不同的时钟：一个是墙上时钟，一个是单调时钟。虽然他们都衡量时间，但要仔细区分二者，本质上他们是服务于不同的目的。

###### 墙上时钟
墙上时钟又称为钟表时间，顾名思义，和我们平时使用的钟表的时间一样，表示形式为日期与时间。在 linux 系统中墙上时钟的表示形式为 UTC 时间，
记录的是自公元 1970 年 1 月 1 日 0 时 0 分 0 秒以来的秒数和毫秒数（不含闰秒）

墙上时钟可以与 NTP 同步，但是存在一些问题造成其并不可靠：
* 当本地时钟远远快于 NTP 服务器，强行重置之后会跳回先前的某个时间点（回拨问题）。并且这种跳跃经常忽略闰秒，导致其不太适合测量时间间隔
* 计算机中石英钟不够准确，存在漂移现象（运行速度会加快或减慢）
* 如果时钟和 NTP 服务器的时钟差别太大，可能会出现拒绝同步
* NTP 同步受限于网络环境，如果网络延迟较大，NTP 同步时间的准确性也会收到影响

###### 单调时钟
单调时钟可以保证时间是向前的，不会出现墙上时钟的回拨问题。它非常适合用来测量持续时间段，比如在一个时间点读取单调时钟的值，完成某项工作后再次获得单调时钟的值，
时钟值之差为两次检测之间的时间间隔。 

但是单调时钟的绝对值没有任何意义，它可能是计算机自启动以后经历的纳秒数等等。因此比较不同节点上的单调时钟的值是没有意义的。

#### 进程暂停
垃圾回收时可能会需要较长时间，此时进程不会处理外部请求。


