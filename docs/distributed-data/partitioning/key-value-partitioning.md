#### 键-值数据的分区
分区的主要目的是将数据和查询负载均匀的分布在所有节点上。如果能够均匀分布，那么理论上 10 个节点能够处理的数据量和读写吞吐量是单个节点的 10 倍。

如果分区不均匀，那么有可能出现某些节点的承担的数据量和查询负载大于其它的节点。称之为`倾斜`。在极端条件下，所有的负载可能都会集中在一个节点上，
那么系统的瓶颈就在这个节点上。这种负载严重不成比例的分区称为`系统热点`。

避免热点最简单的办法是将数据随机的分布到所有的节点上，但是当需要获取某个数据时，因为不知道该数据存储在哪个节点上，只能查询所有的节点。采用哪种
方法对数据进行分区不是一件容易的事情。

#### 基于关键字区间分区
一种分区方式是为每个分区分配一段连续的关键字或关键字区间范围。这样通过数据的关键字就能知道这个数据在哪个区间，在哪个节点上。用户查询数据就可以
向指定的节点发起请求。

不过需要注意的是关键字的区间范围不一定需要均匀分布到每一个分区。比如分区 1 分配 a,b,c，分区 2 分配 d,e,f，像这样简单的均匀分布明显分区 1 的
负载要远大于分区 2。为了更加均匀地分布数据，分区边界应该适配数据本身的分布特征。

基于关键字的区间分区在某些场景下会导致热点。比如关键字是时间，分区对应的是一个时间范围。那么当测量数据从传感器写入数据库时，数据全部都写入到一个分区
里面，并且其它的分区都处于空闲状态。

解决上面的例子遇到的问题，一个方法是修改关键字为`传感器名称-时间`。这样数据会先按照传感器的名称进行分区，然后再按照时间分区，最终在写入时数据会均匀
的写入到每一个节点。

#### 基于关键字哈希值分区
基于关键字哈希值分区能够将数据均匀的分布到所有的分区中。然而这种方式会丧失数据的良好区间性，即使关键字相邻，但是经过哈希之后数据也会分布到不同的分区中。
区间查询就失去了原有的有序相邻的特性。比如要查询最近 1 个月的气温数据，就不得不请求所有的分区来查询数据，最后再汇总给客户端。

有的数据库对此做了优化，使用多个列组成的复合主键，且只有复合主键的第一列可以用于哈希分区。这样会把同类型的数据都聚合到同一个分区中。
如用户行为表的复合主键为`name_action_time`，根据`name`字段来哈希分区，那么一个用户的所有行为数据都会存放在同一个分区里面。

#### 负载倾斜与热点
如前所述，基于关键字哈希值分区可以减轻热点，但是无法做到完全避免。一个极端的情况是所有的`读/写`操作都是针对同一个关键字，那么所有的请求都会被路由到
同一个分区。

比如，微博上一个名人有上千万的粉丝，当其发布一些热门的帖子时会出现大量的对相同关键字的写操作。此时哈希起不到任何作用，因为它们的关键字都是相同的。
系统无法自动消除这种高度倾斜的负载，只能从应用层着手。比如说当某个关键字被确认为热点关键字后，在关键字的结尾处加一个 2 位的随机数，那么针对该关键字
的写入会被分布到 100 个不同的关键字上，从而分布到不同的分区中。